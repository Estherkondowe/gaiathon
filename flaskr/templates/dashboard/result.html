<!DOCTYPE html>
<html>
  <head>
    <title>Optimized Route</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      #map {
        height: 500px;
        width: 100%;
        margin: 20px 0;
      }
      .info-panel {
        background: #f5f5f5;
        padding: 15px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .coord-list {
        margin: 10px 0;
      }
      .coord-item {
        padding: 5px;
        margin: 2px 0;
        background: #e9e9e9;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <h1>Optimized Walking Route</h1>

    <div class="info-panel">
      <h3>Route Information</h3>
      <p>
        <strong>Total Distance:</strong>
        <span id="distance">Calculating...</span>
      </p>
      <p>
        <strong>Estimated Duration:</strong>
        <span id="duration">Calculating...</span>
      </p>
      <p><strong>Number of Waypoints:</strong> {{ coords|length }}</p>
    </div>

    <div id="map"></div>

    <div class="info-panel">
      <h3>Waypoints</h3>
      <div class="coord-list">
        {% for coord in coords %}
        <div class="coord-item">
          Point {{ loop.index }}: {{ coord[0] }}, {{ coord[1] }}
        </div>
        {% endfor %}
      </div>
    </div>

    <div class="info-panel">
      <a href="/">← Plan Another Route</a>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // Get the route data from Flask
      const routeData = {{ route_geojson|safe }};

      console.log('Route data:', routeData);

      // Initialize the map
      const map = L.map('map');

      // Add OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      if (routeData && routeData.features && routeData.features.length > 0) {
          // Add the route to the map
          const routeLayer = L.geoJSON(routeData, {
              style: {
                  color: '#3388ff',
                  weight: 5,
                  opacity: 0.8
              }
          }).addTo(map);

          // Add markers for waypoints
          const coords = {{ coords|tojson }};
          coords.forEach((coord, index) => {
              const marker = L.marker([coord[0], coord[1]]).addTo(map);
              marker.bindPopup(`Waypoint ${index + 1}<br>Lat: ${coord[0]}<br>Lon: ${coord[1]}`);
          });

          // Fit the map to show the entire route
          map.fitBounds(routeLayer.getBounds(), { padding: [20, 20] });

          // Extract and display route information
          const feature = routeData.features[0];
          if (feature.properties) {
              const summary = feature.properties.summary;
              if (summary) {
                  // Distance in meters, convert to km
                  const distance = (summary.distance / 1000).toFixed(2);
                  document.getElementById('distance').textContent = distance + ' km';

                  // Duration in seconds, convert to minutes
                  const duration = Math.round(summary.duration / 60);
                  document.getElementById('duration').textContent = duration + ' minutes';
              }
          }
      } else {
          // No route data, just show the waypoints
          const coords = {{ coords|tojson }};
          if (coords.length > 0) {
              const group = new L.FeatureGroup();

              coords.forEach((coord, index) => {
                  const marker = L.marker([coord[0], coord[1]]).addTo(map);
                  marker.bindPopup(`Waypoint ${index + 1}<br>Lat: ${coord[0]}<br>Lon: ${coord[1]}`);
                  group.addLayer(marker);
              });

              map.fitBounds(group.getBounds(), { padding: [20, 20] });
          }

          document.getElementById('distance').textContent = 'Route not available';
          document.getElementById('duration').textContent = 'Route not available';
      }
    </script>
  </body>
</html>
